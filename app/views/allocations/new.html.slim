section.section
  .container
    .content.has-text-centered
      h1.title.is-spaced
        => icon_tag('fa-cart-plus')
        br
        | Add a charity to your portfolio

      p Do you have charities that you'd like to add to your portfolio?

section.section.embossed
  .container.has-text-centered
    .level
      .level-item
        span.icon.is-large: i.fas.fa-search
        #search-input
    p.help You can add any 501(c)3 recognized organization to your portfolio
    #search-hits
    hr
    p.is-4.has-text-centered OR
    hr
    h3.has-text-centered.title Choose one of our vetted high-impact charities
    p.has-text-centered Donational recommends these high impact charities. Add one to your portfolio!
    br

    - if @model.addable_organizations.empty?
      p.notification.is-warning You have all of our recommended charities in your portfolio!

    ul.columns.is-multiline.is-centered.book-list.content
      - @model.addable_organizations.each do |organization|
        li.column.is-4
          = render 'portfolios/book', organization: organization
          = form_with url: allocations_path, local: true, method: :post do |f|
            = f.fields :organization do |organization_form|
              = organization_form.hidden_field :ein, value: organization.ein
              = organization_form.hidden_field :name, value: organization.name
            = f.submit class:'button is-primary', value: 'Add to portfolio'

    p
      ' Want to donate to a charity that isn't listed here?
      a href='#search-for-a-charity'
        | Search for a charity

  = render 'search_result'

  javascript:
    var search = instantsearch({
      appId: 'EZ0RKGG8TJ',
      apiKey: 'c8a2dbd3c43a16b24b63d52875582b7e',
      indexName: 'Publication78',
      searchFunction(helper) {
        if (helper.state.query === '') {
          return;
        }
        helper.search();
      },
    });
    search.addWidget(
      instantsearch.widgets.searchBox({
        container: '#search-input',
        cssClasses: { input: 'input is-large' },
        placeholder: 'Search for a charity',
        magnifier: false,
        reset: false
      })
    );
    search.addWidget(
      instantsearch.widgets.hits({
        container: '#search-hits',
        cssClasses: {
          item: ['column', 'is-4'],
          root: ['columns', 'is-multiline']
        },
        templates: {
          item: document.getElementById('hit_template').innerHTML,
          empty: 'no results'
        },
        transformData: function(result) {
          result.formattedEin = result.ein.toString().substring(0, 2) + '-' + result.ein.toString().substring(2, 9);
          if (result.npo.business_master) {
            result.state = result.npo.business_master.state;
            result.classifications = result.npo.business_master.classifications;
          } else if (result.npo.form990_n) {
            result.state = result.npo.form990_n.org_state;
            result.classifications = [];
          }
          return result;
        }
      })
    );
    search.start();
